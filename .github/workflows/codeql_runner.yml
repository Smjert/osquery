# For most projects, this workflow file will not need changing; you simply need
# to commit it to your repository.
#
# You may wish to alter this file to override the set of languages analyzed,
# or to provide custom queries or build logic.
#
# ******** NOTE ********
# We have attempted to detect the languages in your repository. Please check
# the `language` matrix defined below to confirm you have the correct set of
# supported CodeQL languages.
#
name: "CodeQL"

on:
  pull_request:
    # The branches below must be a subset of the branches above
    branches: [ master ]

env:
  SUBMODULE_CACHE_VERSION: 1

jobs:
  analyze:
    name: Analyze

    runs-on: ubuntu-18.04

    container:
      image: osquery/builder18.04:a4961d234
      options: --privileged --init -v /var/run/docker.sock:/var/run/docker.sock

    permissions:
      actions: read
      contents: read
      security-events: write

    strategy:
      fail-fast: false
      matrix:
        language: [ 'cpp' ]
        # CodeQL supports [ 'cpp', 'csharp', 'go', 'java', 'javascript', 'python', 'ruby' ]
        # Learn more about CodeQL language support at https://git.io/codeql-language-support

    steps:
    - name: Checkout repository
      uses: actions/checkout@v2
      with:
        path: 'osquery'

    # - name: Select the build job count
    #   shell: bash
    #   id: build_job_count
    #   run: |
    #     echo ::set-output name=VALUE::$(($(nproc) + 1))

    # - name: Update the cache (ccache)
    #   uses: actions/cache@v2
    #   with:
    #     path: ${{ steps.build_paths.outputs.CCACHE }}

    #     key: |
    #       ccache_${{ matrix.os }}_${{ matrix.build_type }}_${{ github.sha }}

    #     restore-keys: |
    #       ccache_${{ matrix.os }}_${{ matrix.build_type }}

    # - name: Update the cache (git submodules)
    #   uses: actions/cache@v2
    #   with:
    #     path: ${{ steps.build_paths.outputs.SOURCE }}/.git/modules

    #     key: |
    #       gitmodules_${{ matrix.os }}_${{env.SUBMODULE_CACHE_VERSION}}_${{ github.sha }}

    #     restore-keys: |
    #       gitmodules_${{ matrix.os }}_${{env.SUBMODULE_CACHE_VERSION}}

    # - name: Update the git submodules
    #   working-directory: ${{ steps.build_paths.outputs.SOURCE }}
    #   run: |
    #     git submodule sync --recursive

    # - name: Configure the project
    #   working-directory: ${{ steps.build_paths.outputs.BINARY }}

    #   env:
    #     CCACHE_DIR: ${{ steps.build_paths.outputs.CCACHE }}

    #   run: |
    #     cmake -G "Unix Makefiles" \
    #       -DOSQUERY_NO_DEBUG_SYMBOLS=${{ steps.debug_symbols_settings.outputs.VALUE }} \
    #       -DOSQUERY_TOOLCHAIN_SYSROOT:PATH="/usr/local/osquery-toolchain" \
    #       -DCMAKE_BUILD_TYPE:STRING="${{ matrix.build_type }}" \
    #       -DOSQUERY_BUILD_TESTS=${{ steps.tests_build_settings.outputs.VALUE }} \
    #       -DOSQUERY_BUILD_ROOT_TESTS=${{ steps.tests_build_settings.outputs.VALUE }} \
    #       "${{ steps.build_paths.outputs.SOURCE }}"
      

    # Initializes the CodeQL tools for scanning.
    - name: Initialize CodeQL
      uses: github/codeql-action/init@v1
      with:
        languages: ${{ matrix.language }}
        source-root: .
        # If you wish to specify custom queries, you can do so here or in a config file.
        # By default, queries listed here will override any specified in a config file.
        # Prefix the list here with "+" to use these queries and those in the config file.
        # queries: ./path/to/local/query, your-org/your-repo/queries@main

    - name: "Build code to analyze"
      run: |
        pwd
        ls
        ls osquery
        echo "Workspace: $GITHUB_WORKSPACE"
        echo "LIB: $LIB"
        echo "PLATFORM: $PLATFORM"

    - name: Perform CodeQL Analysis
      uses: github/codeql-action/analyze@v1
